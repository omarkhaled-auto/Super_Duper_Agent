# =============================================================================
# Agent Team Configuration — RUN 4: End-to-End Integration & Audit
# =============================================================================
# Run 4 is NOT a build — it's a verification/audit run that validates all 3
# builds work together. 57-test verification matrix, SVC wiring validation,
# cross-build contract testing. 5 milestones (M1-M5).
# Python orchestration scripts. Estimated: 5K LOC, $15-25 cost.
# =============================================================================

orchestrator:
  model: opus
  max_turns: 400       # Smaller run — less code to write
  permission_mode: bypassPermissions
  max_budget_usd: 300.0

depth:
  default: exhaustive
  auto_detect: false
  scan_scope_mode: full

convergence:
  max_cycles: 10
  escalation_threshold: 3
  min_convergence_ratio: 0.9
  recovery_threshold: 0.8

interview:
  enabled: false       # PRD provides all context

milestone:
  enabled: true
  max_parallel_milestones: 1
  health_gate: true
  wiring_check: true
  review_recovery_retries: 2

prd_chunking:
  enabled: true
  threshold: 80000
  max_chunk_size: 20000

e2e_testing:
  enabled: true        # E2E is CORE to Run 4's mission
  backend_api_tests: true
  frontend_playwright_tests: false
  max_fix_retries: 5   # Extra retries — E2E success is the primary goal
  test_port: 9876
  skip_if_no_api: false   # Don't skip — Run 4 orchestrates the API tests
  skip_if_no_frontend: true

browser_testing:
  enabled: false

integrity_scans:
  deployment_scan: true    # Run 4 validates Docker Compose orchestration
  asset_scan: false
  prd_reconciliation: true

tracking_documents:
  e2e_coverage_matrix: true
  fix_cycle_log: true
  milestone_handoff: true
  coverage_completeness_gate: 0.9    # Higher gate — this is the audit run
  wiring_completeness_gate: 1.0

database_scans:
  dual_orm_scan: false
  default_value_scan: false    # Disabled — false positives on .venv/ wasted fix cycles
  relationship_scan: false

post_orchestration_scans:
  mock_data_scan: false        # Disabled — false positives on .venv/ (charset_normalizer)
  ui_compliance_scan: false
  api_contract_scan: true      # Critical — Run 4 validates ALL SVC contracts
  silent_data_loss_scan: false
  endpoint_xref_scan: false
  max_scan_fix_passes: 1       # Reduced — single pass sufficient

tech_research:
  enabled: true
  max_techs: 6        # Fewer unique techs in Run 4
  max_queries_per_tech: 3
  expanded_queries: true
  max_expanded_queries: 3

verification:
  enabled: true
  blocking: true
  run_lint: true
  run_type_check: true
  run_tests: true
  run_build: true
  run_security: true

audit_team:
  enabled: true
  auditors:
    - requirements
    - technical
    - interface
    - test
    - library
  max_fix_rounds: 2            # Cap at 2 — Round 3 caused regressions in M2
  severity_gate: HIGH          # Only fix HIGH+ findings

quality:
  production_defaults: true
  craft_review: true
  quality_triggers_reloop: true

scheduler:
  enabled: true
  max_parallel_tasks: 5
  enable_critical_path: true

display:
  show_cost: true
  show_tools: true
  show_fleet_composition: true
  show_convergence_status: true

# Run4-specific configuration (parsed by Run4Config, ignored by AgentTeamConfig)
run4:
  build1_project_root: "C:/MY_PROJECTS/super-team"
  build2_project_root: "C:/MY_PROJECTS/agent-team-v15"
  build3_project_root: "C:/MY_PROJECTS/super-team"
  output_dir: ".run4"
  compose_project_name: "super-team-run4"
  docker_compose_files:
    - "docker/docker-compose.infra.yml"
    - "docker/docker-compose.build1.yml"
    - "docker/docker-compose.traefik.yml"
  health_check_timeout_s: 120
  health_check_interval_s: 3.0
  mcp_startup_timeout_ms: 30000
  mcp_tool_timeout_ms: 60000
  mcp_first_start_timeout_ms: 120000
  max_concurrent_builders: 3
  builder_timeout_s: 1800
  builder_depth: "thorough"
  max_fix_passes: 5
  fix_effectiveness_floor: 0.30
  regression_rate_ceiling: 0.25
  max_budget_usd: 100.0
  sample_prd_path: "tests/run4/fixtures/sample_prd.md"
