generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// TaskStatus: BACKLOG, TODO, IN_PROGRESS, IN_REVIEW, DONE
// TaskPriority: URGENT, HIGH, MEDIUM, LOW
// ProjectRole: ADMIN, MEMBER, VIEWER

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects       ProjectMember[]
  assignedTasks  Task[]          @relation("TaskAssignee")
  createdTasks   Task[]          @relation("TaskCreator")
  comments       Comment[]
  activities     Activity[]

  @@index([email])
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  icon        String?  @default("folder")
  color       String?  @default("#8B5CF6")
  archived    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members    ProjectMember[]
  tasks      Task[]
  labels     Label[]
  activities Activity[]

  @@index([archived])
}

model ProjectMember {
  id        String   @id @default(cuid())
  role      String   @default("MEMBER")
  userId    String
  projectId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
}

model Task {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("BACKLOG")
  priority    String   @default("MEDIUM")
  position    Int      @default(0)
  dueDate     DateTime?
  projectId   String
  assigneeId  String?
  creatorId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project  Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee User?      @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  creator  User       @relation("TaskCreator", fields: [creatorId], references: [id])
  subTasks SubTask[]
  labels   TaskLabel[]
  comments Comment[]
  activities Activity[]

  @@index([projectId, status])
  @@index([assigneeId])
  @@index([projectId, position])
  @@index([creatorId])
}

model SubTask {
  id        String   @id @default(cuid())
  title     String
  completed Boolean  @default(false)
  taskId    String
  position  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model Label {
  id        String   @id @default(cuid())
  name      String
  color     String
  projectId String
  createdAt DateTime @default(now())

  project Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   TaskLabel[]

  @@unique([name, projectId])
  @@index([projectId])
}

model TaskLabel {
  id      String @id @default(cuid())
  taskId  String
  labelId String

  task  Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  label Label @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([taskId, labelId])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  taskId    String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model Activity {
  id        String   @id @default(cuid())
  action    String
  details   String?
  taskId    String?
  projectId String?
  actorId   String
  createdAt DateTime @default(now())

  task    Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  actor   User     @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([projectId])
  @@index([actorId])
  @@index([createdAt])
}
